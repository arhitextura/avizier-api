CREATE VIEW ConsumLunar AS WITH Diferentaconsum (id_cons, worksheet, index_citire, index_anterior) AS ( SELECT id_consumator, (SELECT worksheet_name FROM consumatori WHERE consumatori.id = id_consumator ) as nume, index_citit, (LAG(index_citit, 1) OVER (PARTITION BY id_consumator ORDER BY data_citire_index DESC)) as previos_index FROM index_lunar) SELECT * FROM Diferentaconsum WHERE index_anterior IS NOT NULL